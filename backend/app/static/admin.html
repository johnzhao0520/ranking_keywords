<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeywordTracker ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar { width: 240px; }
        .main-content { flex: 1; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- Login Page -->
        <div id="login-page" class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-md w-96">
                <h1 class="text-2xl font-bold mb-6 text-center">KeywordTracker ç™»å½•</h1>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">é‚®ç®±</label>
                        <input type="email" id="login-email" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å¯†ç </label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">ç™»å½•</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showRegister()" class="text-blue-600">æ³¨å†Œ</a>
                </p>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="min-h-screen flex items-center justify-center hidden">
            <div class="bg-white p-8 rounded-lg shadow-md w-96">
                <h1 class="text-2xl font-bold mb-6 text-center">KeywordTracker æ³¨å†Œ</h1>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">é‚®ç®±</label>
                        <input type="email" id="reg-email" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ç”¨æˆ·å</label>
                        <input type="text" id="reg-username" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å¯†ç </label>
                        <input type="password" id="reg-password" class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">æ³¨å†Œ</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showLogin()" class="text-blue-600">ç™»å½•</a>
                </p>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-page" class="flex hidden">
            <!-- Sidebar -->
            <div class="sidebar bg-white shadow-lg min-h-screen">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-bold text-blue-600">KeywordTracker</h1>
                </div>
                <nav class="p-4 space-y-2">
                    <a href="#" onclick="showPage('dashboard')" class="block px-4 py-2 rounded hover:bg-gray-100">ğŸ“Š ä»ªè¡¨ç›˜</a>
                    <a href="#" onclick="showPage('projects')" class="block px-4 py-2 rounded hover:bg-gray-100">ğŸ“ é¡¹ç›®ç®¡ç†</a>
                    <a href="#" onclick="showPage('keywords')" class="block px-4 py-2 rounded hover:bg-gray-100">ğŸ” å…³é”®è¯</a>
                    <a href="#" onclick="showPage('settings')" class="block px-4 py-2 rounded hover:bg-gray-100">âš™ï¸ è®¾ç½®</a>
                    <a href="#" onclick="showPage('admin')" class="block px-4 py-2 rounded hover:bg-gray-100">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
                    <a href="#" onclick="logout()" class="block px-4 py-2 rounded hover:bg-gray-100 text-red-600">ğŸšª é€€å‡º</a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="main-content p-8">
                <!-- Dashboard -->
                <div id="page-dashboard">
                    <h2 class="text-2xl font-bold mb-6">ä»ªè¡¨ç›˜</h2>
                    <div class="grid grid-cols-4 gap-4 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-3xl font-bold text-blue-600" id="stat-projects">0</div>
                            <div class="text-gray-500">é¡¹ç›®æ•°</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-3xl font-bold text-green-600" id="stat-keywords">0</div>
                            <div class="text-gray-500">å…³é”®è¯æ•°</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-3xl font-bold text-orange-600" id="stat-credits">0</div>
                            <div class="text-gray-500">å‰©ä½™ç§¯åˆ†</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-3xl font-bold text-purple-600" id="stat-used">0</div>
                            <div class="text-gray-500">æœ¬æœˆæ¶ˆè€—</div>
                        </div>
                    </div>
                </div>

                <!-- Projects -->
                <div id="page-projects" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">é¡¹ç›®ç®¡ç†</h2>
                        <button onclick="showCreateProject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ æ–°å»ºé¡¹ç›®</button>
                    </div>
                    <div id="projects-list" class="space-y-4"></div>
                </div>

                <!-- Keywords -->
                <div id="page-keywords" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">å…³é”®è¯ç®¡ç†</h2>
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <div class="flex gap-4">
                            <select id="project-select" class="border rounded px-3 py-2" onchange="loadKeywords()">
                                <option value="">é€‰æ‹©é¡¹ç›®</option>
                            </select>
                            <input type="text" id="new-keyword" placeholder="è¾“å…¥å…³é”®è¯" class="border rounded px-3 py-2 flex-1">
                            <select id="country-select" class="border rounded px-3 py-2">
                                <option value="com">ç¾å›½ (Google.com)</option>
                                <option value="co.uk">è‹±å›½</option>
                                <option value="co.jp">æ—¥æœ¬</option>
                                <option value="de">å¾·å›½</option>
                                <option value="fr">æ³•å›½</option>
                                <option value="com.au">æ¾³å¤§åˆ©äºš</option>
                                <option value="ca">åŠ æ‹¿å¤§</option>
                                <option value="cn">ä¸­å›½</option>
                            </select>
                            <select id="interval-select" class="border rounded px-3 py-2">
                                <option value="24">æ¯å¤©1æ¬¡</option>
                                <option value="48">2å¤©1æ¬¡</option>
                                <option value="72">3å¤©1æ¬¡</option>
                                <option value="168">7å¤©1æ¬¡</option>
                            </select>
                            <button onclick="addKeyword()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">æ·»åŠ </button>
                        </div>
                        <div id="keyword-target" class="mt-2 text-sm text-gray-500"></div>
                    </div>
                    <div id="keywords-list" class="space-y-2"></div>
                </div>

                <!-- Settings -->
                <div id="page-settings" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">è´¦æˆ·è®¾ç½®</h2>
                    <div class="bg-white rounded-lg shadow p-6 max-w-lg">
                        <h3 class="font-bold mb-4">å……å€¼ç§¯åˆ†</h3>
                        <p class="text-gray-500 mb-4">è”ç³»ç®¡ç†å‘˜è´­ä¹°ç§¯åˆ†</p>
                    </div>
                </div>

                <!-- Admin: User Management -->
                <div id="page-admin" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">ç”¨æˆ·ç®¡ç†</h2>
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <div class="flex gap-4">
                            <input type="text" id="admin-user-email" placeholder="ç”¨æˆ·é‚®ç®±" class="border rounded px-3 py-2 flex-1">
                            <input type="number" id="admin-credits-amount" placeholder="ç§¯åˆ†æ•°é‡" class="border rounded px-3 py-2 w-32">
                            <button onclick="adminAddCredits()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">æ·»åŠ ç§¯åˆ†</button>
                        </div>
                    </div>
                    <div id="users-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://rankingkeywords-production.up.railway.app/api';
        let token = localStorage.getItem('token');
        let userId = null;

        // é¡µé¢åˆ‡æ¢
        function showPage(page) {
            ['dashboard', 'projects', 'keywords', 'settings', 'admin'].forEach(p => {
                document.getElementById('page-' + p).classList.add('hidden');
            });
            document.getElementById('page-' + page).classList.remove('hidden');
            if (page === 'dashboard') loadDashboard();
            if (page === 'projects') loadProjects();
            if (page === 'keywords') { loadProjects(); loadKeywords(); }
            if (page === 'admin') loadAdminUsers();
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('admin-page').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            document.getElementById('admin-page').classList.add('hidden');
        }

        // ç™»å½•
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', password);

            const res = await fetch(API + '/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            if (res.ok) {
                const data = await res.json();
                token = data.access_token;
                localStorage.setItem('token', token);
                showAdmin();
            } else {
                alert('ç™»å½•å¤±è´¥');
            }
        };

        // æ³¨å†Œ
        document.getElementById('register-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;

            const res = await fetch(API + '/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, password })
            });

            if (res.ok) {
                showLogin();
                alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
            } else {
                alert('æ³¨å†Œå¤±è´¥');
            }
        };

        function showAdmin() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('admin-page').classList.remove('hidden');
            loadDashboard();
        }

        function logout() {
            localStorage.removeItem('token');
            token = null;
            showLogin();
        }

        // åŠ è½½ä»ªè¡¨ç›˜
        async function loadDashboard() {
            const res = await fetch(API + '/users/dashboard', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('stat-projects').textContent = data.total_projects;
                document.getElementById('stat-keywords').textContent = data.total_keywords;
                document.getElementById('stat-credits').textContent = data.credits_remaining;
                document.getElementById('stat-used').textContent = data.credits_used_this_month;
            }
        }

        // åŠ è½½é¡¹ç›®
        async function loadProjects() {
            const res = await fetch(API + '/projects', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                const projects = await res.json();
                const list = document.getElementById('projects-list');
                if (projects.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">æš‚æ— é¡¹ç›®</p>';
                } else {
                    list.innerHTML = projects.map(p => `
                        <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                            <div>
                                <h3 class="font-bold">${p.name}</h3>
                                <p class="text-sm text-gray-500">${p.root_domain}${p.subdomain ? ' / ' + p.subdomain : ''} | ${p.keywords_count} ä¸ªå…³é”®è¯</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="shareProject(${p.id}, '${p.name}')" class="text-blue-600 hover:text-blue-800 text-sm">åˆ†äº«</button>
                                <button onclick="deleteProject(${p.id})" class="text-red-600">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // æ›´æ–°é¡¹ç›®ä¸‹æ‹‰
                const select = document.getElementById('project-select');
                select.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®</option>' + projects.map(p => `<option value="${p.id}" data-root="${p.root_domain}" data-sub="${p.subdomain || ''}">${p.name} (${p.subdomain || p.root_domain})</option>`).join('');
            }
        }

        // åˆ›å»ºé¡¹ç›® - å¸¦åŸŸå
        async function createProject(name, root_domain, subdomain) {
            const res = await fetch(API + '/projects', {
                method: 'POST',
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, root_domain, subdomain })
            });
            if (res.ok) {
                loadProjects();
                return true;
            }
            return false;
        }

        function showCreateProject() {
            const name = prompt('è¯·è¾“å…¥é¡¹ç›®åç§°:');
            if (!name) return;
            const root_domain = prompt('è¯·è¾“å…¥æ ¹åŸŸå (å¦‚ narwal.com):');
            if (!root_domain) return;
            const subdomain = prompt('è¯·è¾“å…¥äºŒçº§åŸŸå (å¯é€‰ï¼Œå¦‚ ca.narwal.com):') || '';
            createProject(name, root_domain, subdomain);
        }

        async function deleteProject(id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            await fetch(API + '/projects/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            loadProjects();
        }

        // åŠ è½½å…³é”®è¯
        async function loadKeywords() {
            const projectId = document.getElementById('project-select').value;
            if (!projectId) return;

            // æ˜¾ç¤ºç›®æ ‡åŸŸå
            const select = document.getElementById('project-select');
            const option = select.options[select.selectedIndex];
            const rootDomain = option.dataset.root || '';
            const subDomain = option.dataset.sub || '';
            const targetUrl = subDomain || rootDomain;
            document.getElementById('keyword-target').textContent = 'è¿½è¸ªç›®æ ‡: ' + targetUrl;

            const res = await fetch(API + '/projects/' + projectId + '/keywords', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                const keywords = await res.json();
                const list = document.getElementById('keywords-list');
                if (keywords.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">æš‚æ— å…³é”®è¯</p>';
                } else {
                    list.innerHTML = keywords.map(k => `
                        <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                            <div class="cursor-pointer flex-1" onclick="showKeywordHistory(${k.id}, '${k.keyword}')">
                                <span class="font-bold">${k.keyword}</span>
                                <span class="text-sm text-gray-500 ml-2">${targetUrl} | ${k.country_code} / ${k.tracking_interval_hours}h</span>
                                ${k.latest_rank ? `<span class="ml-2 px-2 py-1 bg-green-100 text-green-700 rounded">#${k.latest_rank}</span>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="trackKeyword(${k.id}, this)" class="text-blue-600 hover:text-blue-800 text-sm">è¿½è¸ª</button>
                                <button onclick="deleteKeyword(${k.id})" class="text-red-600 ml-2">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // æ˜¾ç¤ºå…³é”®è¯å†å²æ›²çº¿
        async function showKeywordHistory(keywordId, keyword) {
            const res = await fetch(API + '/keywords/' + keywordId + '/history', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (!res.ok) {
                alert('è·å–å†å²å¤±è´¥');
                return;
            }
            
            const data = await res.json();
            
            // æ„å»ºå¼¹çª—å†…å®¹
            let html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-auto" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold mb-4">${keyword} - æ’åå†å²</h3>
                        <div class="mb-4">
                            <canvas id="rankChart" height="200"></canvas>
                        </div>
                        <h4 class="font-bold mb-2">å†å²è®°å½•ï¼ˆç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰</h4>
                        <div class="space-y-2 max-h-60 overflow-auto">
            `;
            
            // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤ºå†å²
            const history = data.history || [];
            for (const h of history) {
                const date = new Date(h.checked_at).toLocaleString('zh-CN');
                let serpHtml = '';
                if (h.serp_results) {
                    try {
                        const serp = JSON.parse(h.serp_results);
                        serpHtml = `<div class="mt-2 text-xs text-gray-500">
                            <div class="font-bold mb-1">Top 10 ç«äº‰å¯¹æ‰‹ï¼š</div>
                            ${serp.slice(0,10).map((r, i) => `<div>#${r.position} <a href="${r.link}" target="_blank" class="text-blue-600 hover:underline">${r.title?.substring(0,50)}</a> (${r.domain})</div>`).join('')}
                        </div>`;
                    } catch(e) {}
                }
                
                html += `
                    <div class="border rounded p-2 cursor-pointer hover:bg-gray-50" onclick="this.querySelector('.details').classList.toggle('hidden')">
                        <div class="flex justify-between">
                            <span class="font-bold">${date}</span>
                            <span class="px-2 py-1 bg-green-100 rounded">#${h.rank || '-'}</span>
                        </div>
                        <div class="details hidden mt-2">
                            <div class="text-sm">${h.title || ''}</div>
                            <div class="text-xs text-gray-500 break-all">${h.url || ''}</div>
                            ${serpHtml}
                        </div>
                    </div>
                `;
            }
            
            html += `
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="mt-4 w-full bg-gray-200 py-2 rounded">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // ç»˜åˆ¶æ›²çº¿å›¾
            drawRankChart(history.reverse());
        }

        // ç»˜åˆ¶æ’åæ›²çº¿
        function drawRankChart(history) {
            const ctx = document.getElementById('rankChart');
            if (!ctx) return;
            
            // ä½¿ç”¨ Chart.js CDN
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = () => renderChart(ctx, history);
                document.head.appendChild(script);
            } else {
                renderChart(ctx, history);
            }
        }

        function renderChart(ctx, history) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => new Date(h.checked_at).toLocaleDateString()),
                    datasets: [{
                        label: 'æ’å',
                        data: history.map(h => h.rank),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            reverse: true,
                            title: { display: true, text: 'æ’å' }
                        }
                    }
                }
            });
        }

        async function addKeyword() {
            const projectId = document.getElementById('project-select').value;
            const keyword = document.getElementById('new-keyword').value;
            const country = document.getElementById('country-select').value;
            const interval = document.getElementById('interval-select').value;

            if (!projectId || !keyword) {
                alert('è¯·é€‰æ‹©é¡¹ç›®å¹¶ç›®æ ‡ç½‘å€ (å¦‚ example.com)');
                return;
            }

            const res = await fetch(API + '/projects/' + projectId + '/keywords', {
                method: 'POST',
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    keyword, 
                    country_code: country,
                    tracking_interval_hours: parseInt(interval)
                })
            });

            if (res.ok) {
                document.getElementById('new-keyword').value = '';
                loadKeywords();
            } else {
                alert('æ·»åŠ å¤±è´¥');
            }
        }

        async function deleteKeyword(id) {
            await fetch(API + '/keywords/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            loadKeywords();
        }

        // åˆ†äº«é¡¹ç›®
        async function shareProject(projectId, projectName) {
            const email = prompt(`è¯·è¾“å…¥è¦åˆ†äº«ç»™ ${projectName} çš„ç”¨æˆ·é‚®ç®±:\n(å¯¹æ–¹éœ€è¦å…ˆæ³¨å†Œæ‰èƒ½æ”¶åˆ°åˆ†äº«)`);
            if (!email) return;
            
            const role = prompt('è§’è‰² (editor/viewer):', 'editor');
            if (!role) return;
            
            const res = await fetch(API + '/projects/' + projectId + '/share', {
                method: 'POST',
                headers: { 
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, role })
            });
            
            if (res.ok) {
                alert('åˆ†äº«æˆåŠŸï¼');
            } else {
                const err = await res.json();
                alert('åˆ†äº«å¤±è´¥: ' + (err.detail || JSON.stringify(err)));
            }
        }

        // æ‰‹åŠ¨è§¦å‘å…³é”®è¯è¿½è¸ª
        async function trackKeyword(id, btn) {
            btn.textContent = 'è¿½è¸ªä¸­...';
            btn.disabled = true;
            try {
                const res = await fetch(API + '/tracking/keywords/' + id + '/track', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const data = await res.json();
                    alert('è¿½è¸ªæˆåŠŸï¼æ’å: #' + (data.rank || 'æœªæ‰¾åˆ°'));
                    loadKeywords();
                } else {
                    const err = await res.json();
                    alert('è¿½è¸ªå¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch(e) {
                alert('è¿½è¸ªå¤±è´¥: ' + e.message);
            }
            btn.textContent = 'è¿½è¸ª';
            btn.disabled = false;
        }

        // ç®¡ç†å‘˜ï¼šåŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadAdminUsers() {
            const res = await fetch(API + '/users/admin/users', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.status === 403) {
                document.getElementById('users-list').innerHTML = '<p class="text-red-500">æƒé™ä¸è¶³</p>';
                return;
            }
            if (res.ok) {
                const users = await res.json();
                document.getElementById('users-list').innerHTML = users.map(u => `
                    <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                        <div>
                            <span class="font-bold">${u.email}</span>
                            <span class="text-sm text-gray-500 ml-2">(${u.username})</span>
                            <span class="text-sm ml-2 px-2 py-1 bg-gray-100 rounded">${u.role}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-blue-600 font-bold">${u.credits} ç§¯åˆ†</div>
                            <button onclick="adminDeleteUser(${u.id}, '${u.email}')" class="text-red-600 hover:text-red-800 text-sm">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ç®¡ç†å‘˜ï¼šåˆ é™¤ç”¨æˆ·
        async function adminDeleteUser(userId, email) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ' + email + ' å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            const res = await fetch(API + '/users/admin/users/' + userId, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (res.ok) {
                alert('åˆ é™¤æˆåŠŸ');
                loadAdminUsers();
            } else {
                const err = await res.json();
                alert('åˆ é™¤å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // ç®¡ç†å‘˜ï¼šæ·»åŠ ç§¯åˆ†
        async function adminAddCredits() {
            const email = document.getElementById('admin-user-email').value;
            const amount = parseInt(document.getElementById('admin-credits-amount').value);
            
            if (!email || !amount) {
                alert('è¯·è¾“å…¥é‚®ç®±å’Œç§¯åˆ†æ•°é‡');
                return;
            }
            
            const res = await fetch(API + '/users/admin/add-credits?user_email=' + encodeURIComponent(email) + '&amount=' + amount, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (res.ok) {
                const data = await res.json();
                alert('æ·»åŠ æˆåŠŸï¼æ–°ä½™é¢: ' + data.new_balance);
                loadAdminUsers();
            } else {
                const err = await res.json();
                alert('æ·»åŠ å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        // åˆå§‹åŒ–
        if (token) {
            showAdmin();
        } else {
            showLogin();
        }

        document.getElementById('project-select').onchange = loadKeywords;
    </script>
</body>
</html>
